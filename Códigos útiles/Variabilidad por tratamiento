####################################--Variación porcentual entre tratamiento--#################33

names(datos)
medias_trat <- datos %>%
  group_by(Tratamiento) %>%
  summarise(
    media_Brix = mean(Brix, na.rm = TRUE),
    media_Humedad = mean(Humedad, na.rm = TRUE),
    media_Pol = mean(Pol, na.rm = TRUE),
    media_Pureza = mean(Pureza, na.rm = TRUE)
  )


variacion_relativa <- function(variable) {
  expand_grid(
    Trat1 = medias_trat$Tratamiento,
    Trat2 = medias_trat$Tratamiento
  ) %>%
    filter(Trat1 != Trat2) %>%
    left_join(medias_trat %>% select(Tratamiento, media = all_of(variable)), 
              by = c("Trat1" = "Tratamiento")) %>%
    rename(Media1 = media) %>%
    left_join(medias_trat %>% select(Tratamiento, media = all_of(variable)), 
              by = c("Trat2" = "Tratamiento")) %>%
    rename(Media2 = media) %>%
    mutate(
      Variacion_porcentual = ((Media2 - Media1) / Media1) * 100
    ) %>%
    arrange(Trat1, Trat2)
}

var_Brix <- variacion_relativa("media_Brix") %>% mutate(Variable = "Brix")
var_Humedad <- variacion_relativa("media_Humedad") %>% mutate(Variable = "Humedad")
var_Pol <- variacion_relativa("media_Pol") %>% mutate(Variable = "Pol")
var_Pureza <- variacion_relativa("media_Pureza") %>% mutate(Variable = "Pureza")


variaciones_totales <- bind_rows(var_Brix, var_Humedad, var_Pol, var_Pureza) %>%
  select(Variable, Trat1, Trat2, Media1, Media2, Variacion_porcentual)


variaciones_totales
print(variaciones_totales, n=Inf)


# Contrastes:

names(datos)
anova_Brix<- aov(Brix ~ Tratamiento + Replica) 
anova_Humedad<- aov(Humedad ~ Tratamiento + Replica) 
anova_Pol<- aov(Pol ~ Tratamiento + Replica) 
anova_Pureza<- aov(Pureza ~ Tratamiento + Replica) 

TukeyHSD(anova_Brix); TukeyHSD(anova_Humedad); TukeyHSD(anova_Pol); TukeyHSD(anova_Pureza)




#########--% de variación que aporta cada tratamiento--#################

# Suponiendo que tus datos están en 'datos' y tu variable es 'Brix'
medias <- aggregate(Brix ~ Tratamiento, data = datos, FUN = mean)
n_rep <- table(datos$Tratamiento)
media_total <- mean(datos$Brix)

medias$SS_tratamiento <- n_rep * (medias$Brix - media_total)^2

SS_total <- sum((datos$Brix - media_total)^2)
SS_trat <- sum(medias$SS_tratamiento)

# Porcentaje sobre el total
medias$Pct_total <- medias$SS_tratamiento / SS_total * 100

# Porcentaje relativo dentro del tratamiento
medias$Pct_trat <- medias$SS_tratamiento / SS_trat * 100

medias


# Gráfico del % de variación aportado por cada tratamiento respecto a los residuos


variables <- c("No_Tallo", "Brix", "Humedad", "Pol", "Pureza")

# Función para calcular porcentaje de variabilidad por nivel y residual
calc_var_contrib <- function(var) {
  formula <- as.formula(paste(var, "~ Tratamiento + Replica"))
  aov_model <- aov(formula, data = datos)
  
  # Suma de cuadrados total
  ss_total <- sum(summary(aov_model)[[1]][, "Sum Sq"])
  
  # Suma de cuadrados residual
  ss_residual <- summary(aov_model)[[1]]["Residual", "Sum Sq"]
  
  # Calcular sumas de cuadrados por nivel de tratamiento
  mean_by_trat <- datos %>%
    group_by(Tratamiento) %>%
    summarise(mean_val = mean(.data[[var]], na.rm = TRUE))
  
  # Suma de cuadrados por nivel (desviación respecto a la media general)
  grand_mean <- mean(datos[[var]], na.rm = TRUE)
  mean_by_trat <- mean_by_trat %>%
    mutate(SS_trat = (mean_val - grand_mean)^2 * length(datos[[var]]) / nrow(mean_by_trat),
           Pct_total = SS_trat / ss_total * 100)
  
  # Agregar residual
  df_plot <- mean_by_trat %>%
    select(Fuente = Tratamiento, Pct_total)
  df_plot <- rbind(df_plot, data.frame(Fuente = "Residual", Pct_total = ss_residual / ss_total * 100))
  df_plot$Variable <- var
  return(df_plot)
}

# Aplicar a todas las variables
df_all <- lapply(variables, calc_var_contrib) %>% bind_rows()

# Gráfico
ggplot(df_all, aes(x = Variable, y = Pct_total, fill = Fuente)) +
  geom_bar(stat = "identity") +
  labs(y = "% de variabilidad total", x = "Variable",
       title = "Contribución de cada tratamiento y residual") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
