# Instalar y cargar paquetes
if (!require("MASS")) install.packages("MASS")
if (!require("betareg")) install.packages("betareg")
if (!require("emmeans")) install.packages("emmeans")
if (!require("DHARMa")) install.packages("DHARMa")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("performance")) install.packages("performance")

library(MASS)
library(betareg)
library(emmeans)
library(DHARMa)
library(ggplot2)
library(performance)



# 1. MODELO BINOMIAL NEGATIVA
attach(datos)
modelo_nb <- glm.nb(datos$ind_m2 ~ datos$Tratamiento + datos$Replica, data = datos)
summary(modelo_nb)
Anova(modelo_nb)

sim_res_nb <- simulateResiduals(fittedModel = modelo_nb, n = 1000)
plot(sim_res_nb)
testDispersion(sim_res_nb)

ems_nb_trat <- emmeans(modelo_nb, ~ Tratamiento, type = "response")
pairs_nb_trat <- pairs(ems_nb_trat, adjust = "tukey")
print(ems_nb_trat)
print(pairs_nb_trat)




# Cargar librerías necesarias
library(emmeans)
library(multcomp)
library(ggplot2)
library(dplyr)

# 1. Generar el Compact Letter Display
cld_nb_trat <- cld(ems_nb_trat,
                   alpha = 0.15,
                   Letters = LETTERS,
                   adjust = "tukey")

# 2. Convertir el resultado a un data frame y preparar la columna de etiquetas
cld_df <- as.data.frame(cld_nb_trat)

# NOTA: Imprime los nombres de las columnas para verificar, si el error persiste:
# print(names(cld_df)) 

# Crear la columna de etiquetas
cld_df <- cld_df %>%
  mutate(etiqueta = .group)

# 3. Creación del Gráfico de Líneas de Error, USANDO NOMBRES CORRECTOS:
grafico_tukey_nb <- ggplot(cld_df, aes(x = Tratamiento, y = response)) + # <--- ¡CAMBIO CLAVE AQUÍ!
  
  # Bigotes (Intervalos de Confianza)
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.2,
                linewidth = 0.8,
                color = "gray40") +
  
  # Puntos (Medias Estimadas)
  geom_point(size = 4, color = "red") +
  
  # Etiquetas de Letras de Tukey (colocadas por encima del bigote superior)
  geom_text(aes(label = etiqueta, y = asymp.UCL),
            vjust = -0.5,
            size = 5,
            color = "black",
            fontface = "bold") +
  
  # Ajustes estéticos y títulos
  labs(title = "Medias Estimadas por Tratamiento con Letras de Tukey",
       subtitle = "Basado en el Modelo GLM Negativo Binomial",
       x = "Tratamiento",
       y = "Media Estimada de la Respuesta (con IC al 95%)") +
  
  # Tema
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5))

# 4. Imprimir el gráfico
print(grafico_tukey_nb)


# 2. MODELO QUASI-POISSON
modelo_qp <- glm(conteo ~ Tratamiento + Replica, 
                family = quasipoisson(link = "log"), 
                data = datos)
summary(modelo_qp)

sim_res_qp <- simulateResiduals(fittedModel = modelo_qp, n = 1000)
plot(sim_res_qp)

ems_qp_trat <- emmeans(modelo_qp, ~ Tratamiento, type = "response")
pairs_qp_trat <- pairs(ems_qp_trat, adjust = "tukey")
print(ems_qp_trat)
print(pairs_qp_trat)


# 3. MODELO QUASI-BINOMIAL (para porcentajes 0-100%)
# Convertir porcentaje a proporción
datos$prop_porcentaje <- datos$porcentaje / 100

modelo_qb <- glm(prop_porcentaje ~ Tratamiento + Replica,
                family = quasibinomial(link = "logit"),
                data = datos,
                weights = rep(100, nrow(datos)))
summary(modelo_qb)

sim_res_qb <- simulateResiduals(fittedModel = modelo_qb, n = 1000)
plot(sim_res_qb)
testDispersion(sim_res_qb)

ems_qb_trat <- emmeans(modelo_qb, ~ Tratamiento, type = "response")
ems_qb_porcentaje <- ems_qb_trat
ems_qb_porcentaje@grid$emmean <- ems_qb_porcentaje@grid$emmean * 100
pairs_qb_trat <- pairs(ems_qb_trat, adjust = "tukey")

print(ems_qb_porcentaje)
print(pairs_qb_trat)

# 4. MODELO BETA REGRESSION (para porcentajes 0-100%)
# Convertir y ajustar límites
datos$prop_beta <- datos$porcentaje / 100
epsilon <- 0.001
datos$prop_beta[datos$prop_beta == 0] <- epsilon
datos$prop_beta[datos$prop_beta == 1] <- 1 - epsilon

modelo_beta <- betareg(prop_beta ~ Tratamiento + Replica, data = datos)
summary(modelo_beta)

residuos_beta <- residuals(modelo_beta, type = "deviance")
fitted_beta <- fitted(modelo_beta)

par(mfrow = c(2, 2))
plot(fitted_beta, residuos_beta)
abline(h = 0, col = "red")
qqnorm(residuos_beta)
qqline(residuos_beta)
hist(residuos_beta)
plot(density(residuos_beta))
par(mfrow = c(1, 1))

ems_beta_trat <- emmeans(modelo_beta, ~ Tratamiento, type = "response")
ems_beta_porcentaje <- ems_beta_trat
ems_beta_porcentaje@grid$emmean <- ems_beta_porcentaje@grid$emmean * 100
pairs_beta_trat <- pairs(ems_beta_trat, adjust = "tukey")

print(ems_beta_porcentaje)
print(pairs_beta_trat)

# RESUMEN COMPARATIVO
cat("BINOMIAL NEGATIVA - Medias:\n")
print(ems_nb_trat)
cat("Comparaciones:\n")
print(pairs_nb_trat)

cat("QUASI-POISSON - Medias:\n")
print(ems_qp_trat)
cat("Comparaciones:\n")
print(pairs_qp_trat)

cat("QUASI-BINOMIAL - Medias (%):\n")
print(ems_qb_porcentaje)
cat("Comparaciones:\n")
print(pairs_qb_trat)

cat("BETA REGRESSION - Medias (%):\n")
print(ems_beta_porcentaje)
cat("Comparaciones:\n")
print(pairs_beta_trat)

# GRÁFICO COMPARATIVO
resultados_grafico <- data.frame(
  Modelo = rep(c("Binomial Neg", "Quasi-Poisson", "Quasi-Binomial", "Beta"), 
               each = nrow(summary(ems_nb_trat))),
  Tratamiento = rep(summary(ems_nb_trat)$Tratamiento, 4),
  Media = c(
    summary(ems_nb_trat)$emmean,
    summary(ems_qp_trat)$emmean,
    summary(ems_qb_porcentaje)$emmean,
    summary(ems_beta_porcentaje)$emmean
  )
)

ggplot(resultados_grafico, aes(x = Tratamiento, y = Media, fill = Modelo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Comparación de medias ajustadas por modelo", y = "Media ajustada") +
  theme_minimal()

# 5. Modelo Poisson 

library(ggplot2)
library(emmeans)
library(car)

# 1. Ajuste del Modelo Poisson
# Reemplaza 'variable_conteo' por tu variable dependiente (debe ser entera >= 0)
modelo_poisson <- glm(tallos_ha ~ Tratamiento, 
                      data = datos, 
                      family = poisson(link = "log"))

# 2. Resumen del modelo
cat("\n--- Resumen del Modelo Poisson ---\n")
print(summary(modelo_poisson))

# 3. Prueba de Significación Global (Análisis de Desviación)
cat("\n--- Análisis de Desviación (ANOVA para GLM) ---\n")
print(Anova(modelo_poisson, type = "III"))

# 4. Verificación de Sobredispersión
# Si el cociente (Residual deviance / df) es mucho mayor a 1, hay sobredispersión
phi <- summary(modelo_poisson)$deviance / summary(modelo_poisson)$df.residual
cat("\nFactor de Dispersión Estimado:", phi, "\n")

if(phi > 1.5) {
  cat("Aviso: Hay sobredispersión detectada. Se recomienda usar family = quasipoisson.\n")
}

# 5. Comparaciones Múltiples (Medias Estimadas)
# Los resultados se devuelven en la escala original (type = 'response')
emm_poisson <- emmeans(modelo_poisson, ~ Tratamiento, type = "response")
cld_poisson <- as.data.frame(pairs(emm_poisson))

cat("\n--- Comparaciones de Medias (Ratios) ---\n")
print(emm_poisson)

# 6. Gráfico de Diagnóstico de Residuos
par(mfrow = c(2, 2))
plot(modelo_poisson)
par(mfrow = c(1, 1))

# 7. Gráfico de Resultados
ggplot(as.data.frame(emm_poisson), aes(x = Tratamiento, y = rate)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2) +
  geom_point(size = 3, color = "darkblue") +
  labs(title = "Medias Estimadas - Distribución Poisson",
       subtitle = "Intervalos de confianza al 95%",
       y = "Conteo Estimado (Rate)",
       x = "Tratamiento") +
  theme_minimal()
