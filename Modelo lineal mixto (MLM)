trat <- as.factor(Tratamiento)
rep <- as.factor(Replica)
pob <- as.vector(Poblacion)
Pob <- as.numeric(pob)
vr <- as.vector(TCH)
y <- as.numeric(vr)
datos2 <- data.frame(trat, rep, Pob, y); attach(datos2)
view(datos2)

###################################### MLM (Poblacion como factor de efecto aleatorio, la pendiente se considerarÃ¡ fija y el intercepto aleatorio)
modelo_mixto <- lmer(y ~ trat + rep + (1 | Pob))
anova(modelo_mixto)
VarCorr(modelo_mixto)
summary(modelo_mixto)

#Ajuste de medias para hacer PMM
medias <- emmeans(modelo_mixto,~trat);medias
tukey <- pairs(medias, adjust = "tukey"); tukey #ComparaciÃ³n por pares
medias_data.frame <- as.data.frame(medias); attach(medias_data.frame); medias_data.frame


#VerificaciÃ³n de los supuestos
# Normalidad
qqnorm(resid(modelo_mixto), col="red", pch=16, cex=1.3)
qqline(resid(modelo_mixto), lwd=2); par(mar=c(5,6,6,5), cex=0.7)
shapiro.test(resid(modelo_mixto))

# Homocedasticidad
plot(fitted(modelo_mixto), resid(modelo_mixto),
     xlab = "Valores ajustados", ylab = "Residuos")
abline(h = 0, col = "red", lwd=2.5)

leveneTest(resid(modelo_mixto) ~ datos2$trat, center="mean")
